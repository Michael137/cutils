#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include <containers/hashmap.h>

static size_t const sc_hm_min_size_ = 128;

int hm_create( HashMap** map ) {
	*map = malloc( sizeof( HashMap ) + sc_hm_min_size_ * sizeof( LinkedList ) );
	if( map && *map )
	{
		(*map)->size = sc_hm_min_size_;

		size_t i = 0;
		for( ; i < sc_hm_min_size_; ++i)
		{
			LinkedList* llist;
			ll_create( &llist );
			(*map)->buckets[i] = *llist;
		}
		return HM_SUCCESS;
	}
	else
	{
		return HM_INVALID_ARGS;
	}

	return HM_FAILURE;
}

void hm_free( HashMap* map )
{
	free( map );
	map = NULL;
}

// TODO: replace with user-defined hash function
static size_t hash_str( char const* str )
{
	size_t hash = 5381;
	int c;

	while ((c = *str++))
		hash = ((hash << 5) + hash) + c; /* hash * 33 + c */

	return hash;
}

void hm_insert( HashMap** map, void const* key, void const* value )
{
	size_t hsh = hash_str(key);
	size_t idx = hsh % (*map)->size;

	// TODO: error handling
	LinkedList* llist = &((*map)->buckets[idx]);
	HashNode_* node = malloc( sizeof( HashNode_ ) );
	node->key = key;
	node->value = value;
	ll_push_front( &llist, node, sizeof( HashNode_* ) );
}

void* hm_get( HashMap const* map, void const* key )
{
	size_t hsh = hash_str(key);
	size_t idx = hsh % map->size;

	// TODO: implement ll_find with custom comparator
	LinkedList* head = &(map->buckets[idx]);

	while( head != NULL )
	{
		if( strcmp( head->data->key, (char*) key ) == 0 )
		{
			puts( "REACHED" );
			return head->data->value;
		}

		head = head->next;
	}

	//return ll_at( &(map->buckets[idx]), 0 );
}
